function warning(e){"undefined"!=typeof console&&"function"==typeof console.error&&console.error(e);try{throw Error(e)}catch(e){}}function isPlainObject(e){if("object"!==(void 0===e?"undefined":_typeof(e))||null===e)return!1;for(var t=e;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}function createRandomString(e){for(var t="";e>0;){var n=Math.random().toString(16).substring(2);e>n.length?(t+=n,e-=n.length):(t+=n.substring(0,e),e=0)}return t}function uuid(){return createRandomString(8)+"-"+createRandomString(4)+"-"+createRandomString(4)+"-"+createRandomString(4)+"-"+createRandomString(12)}function getSystemInfo(){var e=wx.getSystemInfoSync(),t=e.brand,n=e.model,r=e.pixelRatio,o=e.screenWidth,i=e.screenHeight,a=e.windowWidth,c=e.windowHeight,s=e.statusBarHeight,d=e.system,u=e.language,f=e.version,m=e.platform,h=e.fontSizeSetting,p=e.SDKVersion,_=e.benchmarkLevel;return{$device_model:n,$brand:t,$pixel_ratio:r,$screen_width:o,$screen_height:i,$window_width:a,$window_height:c,$status_bar_height:s,$os:d.split(" ")[0],$os_version:d.split(" ")[1],$language:u,$wx_version:f,$platform:m,$font_size_setting:h,$wx_sdk_version:p,$bench_mark_level:_}}function http(e,t,n){return new Promise(function(r,o){wx.request({url:t,method:e,data:n,success:function(e){return r(e)},fail:function(e){return o(e.errMsg)}})})}function hex_md5(e){return binl2hex(core_md5(str2binl(e),e.length*chrsz))}function b64_md5(e){return binl2b64(core_md5(str2binl(e),e.length*chrsz))}function str_md5(e){return binl2str(core_md5(str2binl(e),e.length*chrsz))}function hex_hmac_md5(e,t){return binl2hex(core_hmac_md5(e,t))}function b64_hmac_md5(e,t){return binl2b64(core_hmac_md5(e,t))}function str_hmac_md5(e,t){return binl2str(core_hmac_md5(e,t))}function core_md5(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;for(var n=1732584193,r=-271733879,o=-1732584194,i=271733878,a=0;e.length>a;a+=16){var c=n,s=r,d=o,u=i;r=md5_ii(r=md5_ii(r=md5_ii(r=md5_ii(r=md5_hh(r=md5_hh(r=md5_hh(r=md5_hh(r=md5_gg(r=md5_gg(r=md5_gg(r=md5_gg(r=md5_ff(r=md5_ff(r=md5_ff(r=md5_ff(r,o=md5_ff(o,i=md5_ff(i,n=md5_ff(n,r,o,i,e[a+0],7,-680876936),r,o,e[a+1],12,-389564586),n,r,e[a+2],17,606105819),i,n,e[a+3],22,-1044525330),o=md5_ff(o,i=md5_ff(i,n=md5_ff(n,r,o,i,e[a+4],7,-176418897),r,o,e[a+5],12,1200080426),n,r,e[a+6],17,-1473231341),i,n,e[a+7],22,-45705983),o=md5_ff(o,i=md5_ff(i,n=md5_ff(n,r,o,i,e[a+8],7,1770035416),r,o,e[a+9],12,-1958414417),n,r,e[a+10],17,-42063),i,n,e[a+11],22,-1990404162),o=md5_ff(o,i=md5_ff(i,n=md5_ff(n,r,o,i,e[a+12],7,1804603682),r,o,e[a+13],12,-40341101),n,r,e[a+14],17,-1502002290),i,n,e[a+15],22,1236535329),o=md5_gg(o,i=md5_gg(i,n=md5_gg(n,r,o,i,e[a+1],5,-165796510),r,o,e[a+6],9,-1069501632),n,r,e[a+11],14,643717713),i,n,e[a+0],20,-373897302),o=md5_gg(o,i=md5_gg(i,n=md5_gg(n,r,o,i,e[a+5],5,-701558691),r,o,e[a+10],9,38016083),n,r,e[a+15],14,-660478335),i,n,e[a+4],20,-405537848),o=md5_gg(o,i=md5_gg(i,n=md5_gg(n,r,o,i,e[a+9],5,568446438),r,o,e[a+14],9,-1019803690),n,r,e[a+3],14,-187363961),i,n,e[a+8],20,1163531501),o=md5_gg(o,i=md5_gg(i,n=md5_gg(n,r,o,i,e[a+13],5,-1444681467),r,o,e[a+2],9,-51403784),n,r,e[a+7],14,1735328473),i,n,e[a+12],20,-1926607734),o=md5_hh(o,i=md5_hh(i,n=md5_hh(n,r,o,i,e[a+5],4,-378558),r,o,e[a+8],11,-2022574463),n,r,e[a+11],16,1839030562),i,n,e[a+14],23,-35309556),o=md5_hh(o,i=md5_hh(i,n=md5_hh(n,r,o,i,e[a+1],4,-1530992060),r,o,e[a+4],11,1272893353),n,r,e[a+7],16,-155497632),i,n,e[a+10],23,-1094730640),o=md5_hh(o,i=md5_hh(i,n=md5_hh(n,r,o,i,e[a+13],4,681279174),r,o,e[a+0],11,-358537222),n,r,e[a+3],16,-722521979),i,n,e[a+6],23,76029189),o=md5_hh(o,i=md5_hh(i,n=md5_hh(n,r,o,i,e[a+9],4,-640364487),r,o,e[a+12],11,-421815835),n,r,e[a+15],16,530742520),i,n,e[a+2],23,-995338651),o=md5_ii(o,i=md5_ii(i,n=md5_ii(n,r,o,i,e[a+0],6,-198630844),r,o,e[a+7],10,1126891415),n,r,e[a+14],15,-1416354905),i,n,e[a+5],21,-57434055),o=md5_ii(o,i=md5_ii(i,n=md5_ii(n,r,o,i,e[a+12],6,1700485571),r,o,e[a+3],10,-1894986606),n,r,e[a+10],15,-1051523),i,n,e[a+1],21,-2054922799),o=md5_ii(o,i=md5_ii(i,n=md5_ii(n,r,o,i,e[a+8],6,1873313359),r,o,e[a+15],10,-30611744),n,r,e[a+6],15,-1560198380),i,n,e[a+13],21,1309151649),o=md5_ii(o,i=md5_ii(i,n=md5_ii(n,r,o,i,e[a+4],6,-145523070),r,o,e[a+11],10,-1120210379),n,r,e[a+2],15,718787259),i,n,e[a+9],21,-343485551),n=safe_add(n,c),r=safe_add(r,s),o=safe_add(o,d),i=safe_add(i,u)}return[n,r,o,i]}function md5_cmn(e,t,n,r,o,i){return safe_add(bit_rol(safe_add(safe_add(t,e),safe_add(r,i)),o),n)}function md5_ff(e,t,n,r,o,i,a){return md5_cmn(t&n|~t&r,e,t,o,i,a)}function md5_gg(e,t,n,r,o,i,a){return md5_cmn(t&r|n&~r,e,t,o,i,a)}function md5_hh(e,t,n,r,o,i,a){return md5_cmn(t^n^r,e,t,o,i,a)}function md5_ii(e,t,n,r,o,i,a){return md5_cmn(n^(t|~r),e,t,o,i,a)}function core_hmac_md5(e,t){var n=str2binl(e);n.length>16&&(n=core_md5(n,e.length*chrsz));for(var r=Array(16),o=Array(16),i=0;16>i;i++)r[i]=909522486^n[i],o[i]=1549556828^n[i];var a=core_md5(r.concat(str2binl(t)),512+t.length*chrsz);return core_md5(o.concat(a),640)}function safe_add(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}function bit_rol(e,t){return e<<t|e>>>32-t}function str2binl(e){for(var t=[],n=(1<<chrsz)-1,r=0;e.length*chrsz>r;r+=chrsz)t[r>>5]|=(e.charCodeAt(r/chrsz)&n)<<r%32;return t}function binl2str(e){for(var t="",n=(1<<chrsz)-1,r=0;32*e.length>r;r+=chrsz)t+=String.fromCharCode(e[r>>5]>>>r%32&n);return t}function binl2hex(e){for(var t="",n=0;4*e.length>n;n++)t+="0123456789abcdef".charAt(e[n>>2]>>n%4*8+4&15)+"0123456789abcdef".charAt(e[n>>2]>>n%4*8&15);return t}function binl2b64(e){for(var t="",n=0;4*e.length>n;n+=3)for(var r=(e[n>>2]>>n%4*8&255)<<16|(e[n+1>>2]>>(n+1)%4*8&255)<<8|e[n+2>>2]>>(n+2)%4*8&255,o=0;4>o;o++)t+=8*n+6*o>32*e.length?b64pad:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(r>>6*(3-o)&63);return t}function isNone(e){return void 0===e||null===e||""===e}function code2SessionTrace(e){var t=e.appid,n=e.appSecret,r=e.code2SessionUrl;return new Promise(function(e,o){wx.login({timeout:1e3,success:function(i){var a=i.code;console.log(a),wx.request({url:r,data:{appid:t,appSecret:n,js_code:a,grant_type:"authorization_code"},success:function(t){return e(t)},fail:function(e){return o(e)}})},fail:function(e){return o(e)}})})}function checkRequiredConfig(e){var t=!0,n=e.appKey,r=e.appletId,o=e.appletSecret;return isNone(n)?(warning("Expected the appKey to not be undefined or null or null character string"),t=!1):isNone(r)?(warning("Expected the appletId to not be undefined or null or null character string"),t=!1):isNone(o)&&(warning("Expected the appletSecret to not be undefined or null or null character string"),t=!1),t}function autoPageTrace(e,t){if("string"==typeof t||t instanceof Dttrace){var n=void 0,r=void 0,o=void 0,i=void 0,a=e.onLoad,c=e.onShow,s=e.onHide;e.onLoad=function(e){var t=getCurrentPages();i=e,r=t[t.length-1].route,o=t.length>1?t[t.length-2].route:"直接打开","function"==typeof a&&a.apply(this,arguments)},e.onShow=function(){var e="string"==typeof t?this[t]:t;n=(new Date).getTime(),e.launchRocket(3001,{$query:i,$url_path:r,$referrer:o,$enter_time:n}),"function"==typeof c&&c.apply(this,arguments)},e.onHide=function(){var e="string"==typeof t?this[t]:t,i=(new Date).getTime();e.launchRocket(3002,{$url_path:r,$referrer:o,$enter_time:n,$leave_time:i,$stay_time:i-n}),"function"==typeof s&&s(arguments)}}else warning("Expected the second argument to be a string or an instance of Dttrace");return e}function autoAppTrace(e,t){if("string"==typeof t||t instanceof Dttrace){var n=!0,r=e.onLaunch,o=e.onShow,i=e.onHide;e.onLaunch=function(e){("string"==typeof t?this[t]:t).launchRocket(2003,{$launch_time:(new Date).getTime(),$path:e.path,$query:e.query,$scene:e.scene,$share_ticket:e.shareTicket,$referrer_info:e.referrerInfo}),"function"==typeof r&&r.apply(this,arguments)},e.onShow=function(e){var r="string"==typeof t?this[t]:t;appEnterTime=(new Date).getTime(),n?n=!1:r.launchRocket(2008,{$enter_time:appEnterTime,$path:e.path,$query:e.query,$scene:e.scene,$share_ticket:e.shareTicket,$referrer_info:e.referrerInfo}),"function"==typeof o&&o.apply(this,arguments)},e.onHide=function(){var e="string"==typeof t?this[t]:t,n=(new Date).getTime();e.launchRocket(2009,{$enter_time:appEnterTime,$leave_time:n,$stay_time:n-appEnterTime}),"function"==typeof i&&i.apply(this,arguments)}}else warning("Expected the second argument to be a string or an instance of Dttrace");return e}function AutoPageTrace(e){return function(t){return autoPageTrace(t.prototype,e),t}}function AutoAppTrace(e){return function(t){return autoAppTrace(t.prototype,e),t}}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function e(e,t){for(var n=0;t.length>n;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),_extends=Object.assign||function(e){for(var t=1;arguments.length>t;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},options={appKey:"",server:"https://log.dtstack.net:7001",code2SessionUrl:"https://api.weixin.qq.com/sns/jscode2session",appletId:"",appletSecret:""},get$1=function(e){return e?options[e]:options},set$1=function(e){if(isPlainObject(e))return _extends(options,e);warning("Expected the argument to be a plain object")},options$1={get:get$1,set:set$1},defaultParams={$DTTID:uuid()},customParams={},get$2=function(e){var t=_extends({},defaultParams,getSystemInfo(),customParams);return e?t[e]:t},set$2=function(e){isPlainObject?_extends(customParams,e):warning("Expected argument to be an object")},params={get:get$2,set:set$2},http$1={post:function(e,t){return http("post",e,t)},get:function(e,t){return http("get",e,t)}},b64pad="",chrsz=8,md5={hex_md5:hex_md5,b64_md5:b64_md5,str_md5:str_md5,hex_hmac_md5:hex_hmac_md5,b64_hmac_md5:b64_hmac_md5,str_hmac_md5:str_hmac_md5},hex_md5$1=md5.hex_md5,Dttrace=function(){function e(t){if(classCallCheck(this,e),this.options=options$1,this.params=params,checkRequiredConfig(t)){var n=t.appKey,r=t.server,o={appKey:n,appletId:t.appletId,appletSecret:t.appletSecret};r&&this.options.set("server",r),void 0!==t.params&&(isPlainObject(t.params)?this.params.set(t.params):warning("Expected the params in config to be an object")),""===wx.getStorageSync("$DTTID")&&wx.setStorageSync("$DTTID",uuid()),this.options.set(o)}}return createClass(e,[{key:"launchRocket",value:function(e,t){var n=this;if("number"!=typeof e)throw Error("Expected the first argument to be a number");var r=this.options.get(),o=r.server,i=r.appKey,a=this.params.get(),c=(new Date).getTime();new Promise(function(e,t){var r=n.params.get("$open_id"),o=n.params.get("$union_id");console.log(n.params.get()),isNone(r)||isNone(o)?code2SessionTrace({appid:n.options.get("appletId"),appSecret:n.options.get("appletSecret"),code2SessionUrl:n.options.get("code2SessionUrl")}).then(function(t){var r=t.openid,o=t.unionid;n.params.set({$open_id:r,$union_id:o}),e()}).catch(function(e){return t(e)}):e()}).then(function(){wx.getNetworkType({success:function(n){if("none"!==n.networkType){var r=_extends({},a,t,{$timestamp:c,$token:hex_md5$1(i+""+c),$network_type:n.networkType,$event_id:e});console.log(r),http$1.post(o,r).then(function(e){var t=e.success,n=e.message;t||warning(n)})}else warning("Network Error")}})}).catch(function(e){warning(e.message)})}}]),e}(),appEnterTime=void 0;export{Dttrace,autoPageTrace,autoAppTrace,AutoPageTrace,AutoAppTrace};
