"use strict";function warning(e){void 0!==console&&"function"==typeof console.error&&console.error(e);try{throw Error(e)}catch(e){}}Object.defineProperty(exports,"__esModule",{value:!0});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e};function isPlainObject(e){if("object"!==(void 0===e?"undefined":_typeof(e))||null===e)return!1;for(var t=e;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}var options={appKey:"",server:"https://log.dtstack.net:7001",code2SessionUrl:"https://api.weixin.qq.com/sns/jscode2session",appletId:"",appletSecret:""},get$1=function(e){return e?options[e]:options},set$1=function(e){if(isPlainObject(e))return _extends(options,e);warning("Expected the argument to be a plain object")},options$1={get:get$1,set:set$1};function createRandomString(e){for(var t="";0<e;){var n=Math.random().toString(16).substring(2);n.length<e?(t+=n,e-=n.length):(t+=n.substring(0,e),e=0)}return t}function uuid(){return createRandomString(8)+"-"+createRandomString(4)+"-"+createRandomString(4)+"-"+createRandomString(4)+"-"+createRandomString(12)}var defaultParams={$DTTID:uuid()},customParams={};function getSystemInfo(){var e=wx.getSystemInfoSync(),t=e.system,n=e.language,r=e.version,o=e.platform,i=e.fontSizeSetting,a=e.SDKVersion,c=e.benchmarkLevel;return{$device_model:e.model,$brand:e.brand,$pixel_ratio:e.pixelRatio,$screen_width:e.screenWidth,$screen_height:e.screenHeight,$window_width:e.windowWidth,$window_height:e.windowHeight,$status_bar_height:e.statusBarHeight,$os:t.split(" ")[0],$os_version:t.split(" ")[1],$language:n,$wx_version:r,$platform:o,$font_size_setting:i,$wx_sdk_version:a,$bench_mark_level:c}}var get$2=function(e){var t=_extends({},defaultParams,getSystemInfo(),customParams);return e?t[e]:t},set$2=function(e){isPlainObject?_extends(customParams,e):warning("Expected argument to be an object")},params={get:get$2,set:set$2};function http(e,r,o){return new Promise(function(t,n){wx.request({url:r,method:e,data:o,success:function(e){return t(e)},fail:function(e){return n(e.errMsg)}})})}var http$1={post:function(e,t){return http("post",e,t)},get:function(e,t){return http("get",e,t)}},b64pad="",chrsz=8;function hex_md5(e){return binl2hex(core_md5(str2binl(e),e.length*chrsz))}function b64_md5(e){return binl2b64(core_md5(str2binl(e),e.length*chrsz))}function str_md5(e){return binl2str(core_md5(str2binl(e),e.length*chrsz))}function hex_hmac_md5(e,t){return binl2hex(core_hmac_md5(e,t))}function b64_hmac_md5(e,t){return binl2b64(core_hmac_md5(e,t))}function str_hmac_md5(e,t){return binl2str(core_hmac_md5(e,t))}function core_md5(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;for(var n=1732584193,r=-271733879,o=-1732584194,i=271733878,a=0;a<e.length;a+=16){var c=n,s=r,d=o,u=i;r=md5_ii(r=md5_ii(r=md5_ii(r=md5_ii(r=md5_hh(r=md5_hh(r=md5_hh(r=md5_hh(r=md5_gg(r=md5_gg(r=md5_gg(r=md5_gg(r=md5_ff(r=md5_ff(r=md5_ff(r=md5_ff(r,o=md5_ff(o,i=md5_ff(i,n=md5_ff(n,r,o,i,e[a+0],7,-680876936),r,o,e[a+1],12,-389564586),n,r,e[a+2],17,606105819),i,n,e[a+3],22,-1044525330),o=md5_ff(o,i=md5_ff(i,n=md5_ff(n,r,o,i,e[a+4],7,-176418897),r,o,e[a+5],12,1200080426),n,r,e[a+6],17,-1473231341),i,n,e[a+7],22,-45705983),o=md5_ff(o,i=md5_ff(i,n=md5_ff(n,r,o,i,e[a+8],7,1770035416),r,o,e[a+9],12,-1958414417),n,r,e[a+10],17,-42063),i,n,e[a+11],22,-1990404162),o=md5_ff(o,i=md5_ff(i,n=md5_ff(n,r,o,i,e[a+12],7,1804603682),r,o,e[a+13],12,-40341101),n,r,e[a+14],17,-1502002290),i,n,e[a+15],22,1236535329),o=md5_gg(o,i=md5_gg(i,n=md5_gg(n,r,o,i,e[a+1],5,-165796510),r,o,e[a+6],9,-1069501632),n,r,e[a+11],14,643717713),i,n,e[a+0],20,-373897302),o=md5_gg(o,i=md5_gg(i,n=md5_gg(n,r,o,i,e[a+5],5,-701558691),r,o,e[a+10],9,38016083),n,r,e[a+15],14,-660478335),i,n,e[a+4],20,-405537848),o=md5_gg(o,i=md5_gg(i,n=md5_gg(n,r,o,i,e[a+9],5,568446438),r,o,e[a+14],9,-1019803690),n,r,e[a+3],14,-187363961),i,n,e[a+8],20,1163531501),o=md5_gg(o,i=md5_gg(i,n=md5_gg(n,r,o,i,e[a+13],5,-1444681467),r,o,e[a+2],9,-51403784),n,r,e[a+7],14,1735328473),i,n,e[a+12],20,-1926607734),o=md5_hh(o,i=md5_hh(i,n=md5_hh(n,r,o,i,e[a+5],4,-378558),r,o,e[a+8],11,-2022574463),n,r,e[a+11],16,1839030562),i,n,e[a+14],23,-35309556),o=md5_hh(o,i=md5_hh(i,n=md5_hh(n,r,o,i,e[a+1],4,-1530992060),r,o,e[a+4],11,1272893353),n,r,e[a+7],16,-155497632),i,n,e[a+10],23,-1094730640),o=md5_hh(o,i=md5_hh(i,n=md5_hh(n,r,o,i,e[a+13],4,681279174),r,o,e[a+0],11,-358537222),n,r,e[a+3],16,-722521979),i,n,e[a+6],23,76029189),o=md5_hh(o,i=md5_hh(i,n=md5_hh(n,r,o,i,e[a+9],4,-640364487),r,o,e[a+12],11,-421815835),n,r,e[a+15],16,530742520),i,n,e[a+2],23,-995338651),o=md5_ii(o,i=md5_ii(i,n=md5_ii(n,r,o,i,e[a+0],6,-198630844),r,o,e[a+7],10,1126891415),n,r,e[a+14],15,-1416354905),i,n,e[a+5],21,-57434055),o=md5_ii(o,i=md5_ii(i,n=md5_ii(n,r,o,i,e[a+12],6,1700485571),r,o,e[a+3],10,-1894986606),n,r,e[a+10],15,-1051523),i,n,e[a+1],21,-2054922799),o=md5_ii(o,i=md5_ii(i,n=md5_ii(n,r,o,i,e[a+8],6,1873313359),r,o,e[a+15],10,-30611744),n,r,e[a+6],15,-1560198380),i,n,e[a+13],21,1309151649),o=md5_ii(o,i=md5_ii(i,n=md5_ii(n,r,o,i,e[a+4],6,-145523070),r,o,e[a+11],10,-1120210379),n,r,e[a+2],15,718787259),i,n,e[a+9],21,-343485551),n=safe_add(n,c),r=safe_add(r,s),o=safe_add(o,d),i=safe_add(i,u)}return[n,r,o,i]}function md5_cmn(e,t,n,r,o,i){return safe_add(bit_rol(safe_add(safe_add(t,e),safe_add(r,i)),o),n)}function md5_ff(e,t,n,r,o,i,a){return md5_cmn(t&n|~t&r,e,t,o,i,a)}function md5_gg(e,t,n,r,o,i,a){return md5_cmn(t&r|n&~r,e,t,o,i,a)}function md5_hh(e,t,n,r,o,i,a){return md5_cmn(t^n^r,e,t,o,i,a)}function md5_ii(e,t,n,r,o,i,a){return md5_cmn(n^(t|~r),e,t,o,i,a)}function core_hmac_md5(e,t){var n=str2binl(e);16<n.length&&(n=core_md5(n,e.length*chrsz));for(var r=Array(16),o=Array(16),i=0;i<16;i++)r[i]=909522486^n[i],o[i]=1549556828^n[i];var a=core_md5(r.concat(str2binl(t)),512+t.length*chrsz);return core_md5(o.concat(a),640)}function safe_add(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}function bit_rol(e,t){return e<<t|e>>>32-t}function str2binl(e){for(var t=[],n=(1<<chrsz)-1,r=0;r<e.length*chrsz;r+=chrsz)t[r>>5]|=(e.charCodeAt(r/chrsz)&n)<<r%32;return t}function binl2str(e){for(var t="",n=(1<<chrsz)-1,r=0;r<32*e.length;r+=chrsz)t+=String.fromCharCode(e[r>>5]>>>r%32&n);return t}function binl2hex(e){for(var t="0123456789abcdef",n="",r=0;r<4*e.length;r++)n+=t.charAt(e[r>>2]>>r%4*8+4&15)+t.charAt(e[r>>2]>>r%4*8&15);return n}function binl2b64(e){for(var t="",n=0;n<4*e.length;n+=3)for(var r=(e[n>>2]>>n%4*8&255)<<16|(e[n+1>>2]>>(n+1)%4*8&255)<<8|e[n+2>>2]>>(n+2)%4*8&255,o=0;o<4;o++)t+=32*e.length<8*n+6*o?b64pad:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(r>>6*(3-o)&63);return t}var md5={hex_md5:hex_md5,b64_md5:b64_md5,str_md5:str_md5,hex_hmac_md5:hex_hmac_md5,b64_hmac_md5:b64_hmac_md5,str_hmac_md5:str_hmac_md5},hex_md5$1=md5.hex_md5;function isNone(e){return null==e||""===e}function code2SessionTrace(e){var o=e.appid,i=e.appSecret,a=e.code2SessionUrl;return new Promise(function(n,r){wx.login({timeout:1e3,success:function(e){var t=e.code;console.log(t),wx.request({url:a,data:{appid:o,appSecret:i,js_code:t,grant_type:"authorization_code"},success:function(e){return n(e)},fail:function(e){return r(e)}})},fail:function(e){return r(e)}})})}function checkRequiredConfig(e){var t=!0,n=e.appletId,r=e.appletSecret;return isNone(e.appKey)?(warning("Expected the appKey to not be undefined or null or null character string"),t=!1):isNone(n)?(warning("Expected the appletId to not be undefined or null or null character string"),t=!1):isNone(r)&&(warning("Expected the appletSecret to not be undefined or null or null character string"),t=!1),t}var Dttrace=function(){function r(e){if(classCallCheck(this,r),this.options=options$1,this.params=params,checkRequiredConfig(e)){var t=e.server,n={appKey:e.appKey,appletId:e.appletId,appletSecret:e.appletSecret};t&&this.options.set("server",t),void 0!==e.params&&(isPlainObject(e.params)?this.params.set(e.params):warning("Expected the params in config to be an object")),""===wx.getStorageSync("$DTTID")&&wx.setStorageSync("$DTTID",uuid()),this.options.set(n)}}return createClass(r,[{key:"launchRocket",value:function(n,r){var o=this;if("number"!=typeof n)throw Error("Expected the first argument to be a number");var e=this.options.get(),i=e.server,a=e.appKey,c=this.params.get(),s=(new Date).getTime();new Promise(function(t,n){var e=o.params.get("$open_id"),r=o.params.get("$union_id");console.log(o.params.get()),isNone(e)||isNone(r)?code2SessionTrace({appid:o.options.get("appletId"),appSecret:o.options.get("appletSecret"),code2SessionUrl:o.options.get("code2SessionUrl")}).then(function(e){o.params.set({$open_id:e.openid,$union_id:e.unionid}),t()}).catch(function(e){return n(e)}):t()}).then(function(){wx.getNetworkType({success:function(e){if("none"!==e.networkType){var t=_extends({},c,r,{$timestamp:s,$token:hex_md5$1(a+""+s),$network_type:e.networkType,$event_id:n});console.log(t),http$1.post(i,t).then(function(e){e.success||warning(e.message)})}else warning("Network Error")}})}).catch(function(e){warning(e.message)})}}]),r}();function autoPageTrace(e,n){if("string"==typeof n||n instanceof Dttrace){var r=void 0,o=void 0,i=void 0,a=void 0,c=e.onLoad,t=e.onShow,s=e.onHide;e.onLoad=function(e){var t=getCurrentPages();a=e,o=t[t.length-1].route,i=1<t.length?t[t.length-2].route:"直接打开","function"==typeof c&&c.apply(this,arguments)},e.onShow=function(){var e="string"==typeof n?this[n]:n;r=(new Date).getTime(),e.launchRocket(3001,{$query:a,$url_path:o,$referrer:i,$enter_time:r}),"function"==typeof t&&t.apply(this,arguments)},e.onHide=function(){var e="string"==typeof n?this[n]:n,t=(new Date).getTime();e.launchRocket(3002,{$url_path:o,$referrer:i,$enter_time:r,$leave_time:t,$stay_time:t-r}),"function"==typeof s&&s(arguments)}}else warning("Expected the second argument to be a string or an instance of Dttrace");return e}var appEnterTime=void 0;function autoAppTrace(e,n){if("string"==typeof n||n instanceof Dttrace){var r=!0,t=e.onLaunch,o=e.onShow,i=e.onHide;e.onLaunch=function(e){("string"==typeof n?this[n]:n).launchRocket(2003,{$launch_time:(new Date).getTime(),$path:e.path,$query:e.query,$scene:e.scene,$share_ticket:e.shareTicket,$referrer_info:e.referrerInfo}),"function"==typeof t&&t.apply(this,arguments)},e.onShow=function(e){var t="string"==typeof n?this[n]:n;appEnterTime=(new Date).getTime(),r?r=!1:t.launchRocket(2008,{$enter_time:appEnterTime,$path:e.path,$query:e.query,$scene:e.scene,$share_ticket:e.shareTicket,$referrer_info:e.referrerInfo}),"function"==typeof o&&o.apply(this,arguments)},e.onHide=function(){var e="string"==typeof n?this[n]:n,t=(new Date).getTime();e.launchRocket(2009,{$enter_time:appEnterTime,$leave_time:t,$stay_time:t-appEnterTime}),"function"==typeof i&&i.apply(this,arguments)}}else warning("Expected the second argument to be a string or an instance of Dttrace");return e}function AutoPageTrace(t){return function(e){return autoPageTrace(e.prototype,t),e}}function AutoAppTrace(t){return function(e){return autoAppTrace(e.prototype,t),e}}exports.Dttrace=Dttrace,exports.autoPageTrace=autoPageTrace,exports.autoAppTrace=autoAppTrace,exports.AutoPageTrace=AutoPageTrace,exports.AutoAppTrace=AutoAppTrace;
